# Fiber

## Fiber 的诞生：从同步阻塞到异步调度

在 React 15 及之前的版本中，React 使用的是 Stack Reconciler （栈调和器），采用递归方式处理虚拟 DOM 更新。这一机制存在几个关键瓶颈：

- 不可中断的同步更新：一旦开始渲染，必须一次性完成整个组件树的遍历和比对，无法中途暂停；
- 无优先级控制：所有更新任务平等处理，用户点击等高优先级操作无法插队。
- 长时间任务阻塞主线成：深层次组件树或负责计算会导致 JavaScript 长时间占用主线成，造成页面卡顿甚至冻结。

随着应用复杂度上升，这些问题在动画、手势操作等场景下变得尤为明显。React 团队意识到必须重构底层架构 ———— Fiber 由此诞生。

## Fiber 是什么？三层定义解析

Fiber 不仅是 React 的内部算法更新，更是一种全新的调度架构与数据结构：

1. 作为架构：替代了旧的栈调和器，成为 React 16+ 的默认协调引擎（Fiber Reconciler）
2. 作为数据结构：每个 Fiber 节点对应一个组件实例，存储器类型、Props、状态及关联的 DOM 节点。
3. 作为工作单元：将渲染拆解为可独立执行、暂停或丢弃的小任务单元

```js
// 简化的 Fiber 节点结构示例
{
  type: 'div',             // 组件类型（函数/类/原生标签）
  key: null,               // React 元素 key
  stateNode: divDOM,       // 关联的真实 DOM 节点
  child: Fiber,            // 第一个子节点
  sibling: Fiber,          // 下一个兄弟节点
  return: Fiber,           // 父节点
  pendingProps: {className: 'active'}, // 待处理的 props
  memoizedState: {count: 1}, // 当前状态
  flags: Placement,        // 标记需要执行的副作用（如插入DOM）
}
```

## 核心原理：可中断、优先级调度与增量渲染

Fiber 的突破性在于它解决了同步渲染的根本缺陷，核心原理包含了三个关键设计：

1. 可中断与恢复的渲染机制

- 将渲染任务拆分为原子工作单元（即 Fiber 节点）
- 通过链表结构（`child`、`sibling`、`return`指针）连接节点，使便利
- 当浏览器需要处理高优先级事件（如用户输入）时，React 能立即暂停当前渲染待时间处理完毕后再恢复。

2. 基于优先级的动态调度

React 为任务划分 5 个优先级等级，调度器根据优先级动态调整执行顺序：

| **优先级**       | **场景**               | **处理策略**             |
| ---------------- | ---------------------- | ------------------------ |
| Immediate (最高) | 用户输入、动画         | 当前帧立即执行           |
| UserBlocking     | 交互反馈（如点击响应） | 快速响应，超时提升优先级 |
| Normal (默认)    | 数据更新、渲染         | 常规调度                 |
| Low              | 非关键数据拉取         | 可被高优先级打断         |
| Idle (最低)      | 分析日志、预加载       | 空闲时执行               |

3. 增量渲染与双缓存技术

- 时间切片：将任务分快执行（每块约 5ms），避免长时间占用主线程。
- 双 Fiber 树：
  - Current Tree 当前视图对应的树；
  - WorkInProgress（WIP）Tree：后台构建中的新树

两棵树通过 `alternate` 属性相互引用，WIP 树构建完成后一次性提交替换 Current 树，减少视觉跳跃；

## 实现机制：两段渲染与浏览器协作

### 阶段 1：Reconciliation 协调 ———— 可中断

目标：计算变更集，不直接操作 DOM
过程：

1. 从根节点开始深度优先遍历 Fiber 树
2. 对比新旧节点，标记增、删、改（通过 flags 字段）
3. 若事件切片用尽或收到高优先任务，保存进度并暂停

### 阶段 2：Commit —————— 不可中断

目标：将变更应用到 DOM，执行副作用
过程：

1. 更新 DOM（增删改节点）
2. 调用生命周期钩子
3. 执行 `useEffect` 副作用

### 与事件循环的协作

Fiber 利用 `requestIdleCallback` 在浏览器空闲时执行任务，并通过 `MessageChannel` 模拟调度器优先级队列。高优任务（如点击）通过微任务快速响应，低优先任务在帧空闲期处理。
