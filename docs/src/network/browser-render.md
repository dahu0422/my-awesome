# 浏览器渲染原理详解

浏览器渲染页面的核心流程如下：

1. 解析 HTML，构建 DOM 树
2. 解析 CSS，构建 CSSOM 树
3. 合成渲染树（Render Tree）
4. 布局（Layout/Reflow）
5. 绘制（Paint）
6. 合成（Composite）

## 1. 解析 HTML，构建 DOM 树

- 浏览器接收到 HTML 文档后，会从上到下、边解析边构建 DOM（Document Object Model）树。
- HTML 解析器会将标签、属性、文本节点等转化为 DOM 节点，形成树状结构。
- 解析过程中遇到外部资源（如 `<script>`、`<link>`、`<img>` 等）会发起并行请求。
- 遇到同步脚本（如未加 `async`/`defer` 的 `<script>`）会阻塞 DOM 解析，直到脚本执行完毕。

## 2. 解析 CSS，构建 CSSOM 树

- 浏览器会解析所有样式表，包括外链 CSS、内联 `<style>`、行内样式。
- 解析生成 CSSOM（CSS Object Model）树，描述所有样式规则及其对应关系。
- CSSOM 的构建同样会被外部 CSS 文件的加载所阻塞。
- 只有 DOM 和 CSSOM 都构建完成后，浏览器才能进入下一步渲染。

## 3. 合成渲染树

- 渲染树（Render Tree）结合了 DOM 和 CSSOM，包含页面中所有需要显示的可见节点。
- 渲染树会过滤掉如 `display: none` 的节点，但会保留 `visibility: hidden` 的节点（占位但不可见）。
- 每个渲染树节点都包含内容和计算后的样式信息。

## 4. 布局（Layout/Reflow）

- 浏览器根据渲染树计算每个节点的几何信息（位置、大小、边距等），这个过程称为布局或回流。
- 布局是一个自顶向下的递归过程，父节点的尺寸和位置会影响子节点。
- 触发布局的常见操作有：窗口大小变化、元素尺寸/位置变化、内容变化等。
- 频繁的布局会影响性能，应尽量减少。

## 5. 绘制（Paint）

- 浏览器将渲染树的每个节点转换为实际像素，绘制到屏幕的多个图层上。
- 绘制包括文本、颜色、阴影、边框、图片等视觉效果。
- 复杂的样式（如渐变、阴影、大量图片）会增加绘制开销。

## 6. 合成（Composite）

- 对于包含多个图层（如有 `position: fixed`、`transform`、`opacity`、`canvas`、`video` 等）的页面，浏览器会将各个图层合成，最终输出到屏幕。
- 合成过程通常由 GPU 加速，提升渲染效率。
- 合成阶段还涉及滚动、动画等操作的优化。

## 重排（Reflow）与重绘（Repaint）

- **重排（Reflow）**：

  - 当页面结构发生变化（如添加、删除元素，元素尺寸、位置、布局属性发生变化，或窗口大小变化）时，浏览器需要重新计算渲染树中部分或全部元素的几何属性（位置、大小等），这个过程称为重排。
  - 重排会影响页面的布局，通常会导致后续的重绘。
  - 触发重排的常见操作包括：修改元素的宽高、边距、内边距、定位、显示/隐藏元素、内容变化等。
  - 重排是性能开销较大的操作，频繁重排会导致页面卡顿。

- **重绘（Repaint）**：

  - 当元素的外观样式发生变化（如颜色、背景、边框、阴影等），但不影响布局时，浏览器会重新绘制受影响的元素，这个过程称为重绘。
  - 重绘只会影响视觉效果，不会重新计算布局。
  - 触发重绘的常见操作包括：更改颜色、背景、可见性（如 `visibility`）、阴影等。
  - 重绘的性能开销相对重排较小，但大量重绘同样会影响渲染效率。

- **区别总结**：
  - 重排一定会引发重绘，重绘不一定会引发重排。
  - 优化页面性能时，应尽量减少重排和重绘的次数，合并 DOM 操作，避免逐条修改样式。

## transform 动画与性能优化

### 为什么使用 `transform` 能减少不必要的重排？

- 使用 `transform`（如 `transform: translateX(100px)`）来移动或缩放元素时，**不会影响元素在文档流中的位置和大小**，也不会影响其他元素的布局。
- transform 只会触发合成（Composite），不会引发重排（Reflow），性能开销极小。
- 适合菜单收缩、弹窗动画、拖拽等场景。

**示例：**

```css
/* 推荐：不会触发重排 */
.menu {
  transform: translateX(100px);
}
```

## 渲染优化建议

- 合理使用 `will-change`、`transform`、`opacity` 等属性，减少不必要的重排和重绘。
- 批量操作 DOM，使用文档片段（DocumentFragment）或虚拟 DOM。
- 尽量避免同步布局查询（如频繁读取 `offsetHeight`、`getBoundingClientRect`）。
- 菜单、弹窗等动画优先用 transform 实现。
- 长列表、复杂表格建议虚拟化渲染。

## 现代浏览器渲染架构

- 多进程架构（主进程、渲染进程、GPU 进程等），提升安全性和稳定性。
- 渲染线程与主线程分离，异步处理动画、合成等任务。
