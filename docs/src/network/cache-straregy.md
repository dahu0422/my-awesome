# 缓存策略

## 强缓存

强缓存指的是当浏览器请求资源时，如果该资源已经在本地缓存中并且缓存没有过期，浏览器就直接使用缓存的内容，而不会向服务器发送请求。这种缓存方式的优势是性能最优，因为不需要重新发送请求。

控制方式：

- `Cache-Control`:

  - `Cache-Control: max-age=<秒数>`：指定资源的最大过期时间（即缓存多久后失效）。例如，Cache-Control: max-age=3600 表示资源在缓存中最多保留 3600 秒（即 1 小时）。

  - `Cache-Control: public`：表示该资源可以被所有缓存服务器缓存。

  - `Cache-Control: private`：表示该资源只能被单个用户缓存，不能被共享缓存（如 CDN）缓存。

  - `Cache-Control: no-cache`：表示不使用缓存，始终向服务器发起请求，但实际上还是会用缓存来验证资源的有效性。

  - `Cache-Control: no-store`：表示禁止缓存，不会将资源存储在缓存中。

  - `Cache-Control: immutable`：表示资源在过期之前永远不会更改，浏览器缓存永不过期。

- `Expires`:这是一个日期字段，指定资源的过期时间（过期后浏览器会发起请求）。它是 HTTP/1.0 的缓存控制方式，在 HTTP/1.1 中通常由 Cache-Control 来取代。

示例：

```http
Cache-Control: max-age=86400, public
Expires: Thu, 01 Dec 2025 16:00:00 GMT
```

## 协商缓存 (Conditional Caching)

协商缓存是指浏览器会在缓存的基础上，向服务器发送请求，询问资源是否已经改变。服务器返回一个响应，指示资源是否仍然有效。如果资源没有改变，浏览器就会继续使用本地缓存；如果资源已经改变，服务器会返回最新的资源。

协商缓存通常依赖于两个头部：

- `If-Modified-Since`：客户端将上次缓存时的 Last-Modified 值发送给服务器，服务器判断自上次缓存以来是否有更新。如果没有更新，返回 304 状态码，表示资源未修改。

- `If-None-Match`：客户端将之前的 ETag 值发送给服务器，服务器使用这个值判断资源是否被修改。如果没有修改，返回 304。

示例：

```http
If-Modified-Since: Wed, 21 Oct 2025 07:28:00 GMT
If-None-Match: "5d8c72a5-12345"
```

如果资源未改变，服务器会返回：

```http
HTTP/1.1 304 Not Modified
```

## 强缓存 VS 协商缓存

| 比较项       | 强缓存（Strong Cache）        | 协商缓存（Conditional Cache）   |
| ------------ | ----------------------------- | ------------------------------- |
| 是否发起请求 | ❌ 不发请求，直接用本地缓存   | ✅ 发起请求，询问资源是否有更新 |
| 响应状态码   | 无（直接本地命中）            | 304 Not Modified 或 200 OK      |
| 性能表现     | ✅ 最快，完全避免网络         | 一般，需要一次往返              |
| 精准性       | ❌ 可能资源变了但你还在用旧的 | ✅ 能确认资源是否有变动         |
| 适用场景     | 资源稳定不易变                | 资源变化不频繁但需要实时性      |

## 缓存策略

| 资源类型        | 缓存策略                                  | 原因                                               |
| --------------- | ----------------------------------------- | -------------------------------------------------- |
| HTML 页面       | 协商缓存（no-cache + ETag/Last-Modified） | 保证页面内容更新及时                               |
| JS/CSS 文件     | 强缓存（immutable + max-age + 文件 hash） | 内容变动时文件名变，适合长期缓存                   |
| 图片/字体等资源 | 强缓存（immutable + max-age + 文件 hash） | 通常较大、更新少，强缓存能明显提升加载速度         |
| API 请求        | 视业务需求决定，一般用协商缓存或禁止缓存  | 数据变化频繁时不缓存，静态数据可考虑 ETag 协商缓存 |
