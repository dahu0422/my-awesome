# 输入 URl 加载过程

## 浏览器解析 URL

浏览器会解析出协议、主机名、端口、路径、查询参数等；

## 检查缓存

浏览器会先检查本地缓存（DNS 缓存、HTTP 缓存等），如果资源未过期，可能直接从缓存读取，提升加载速度。

## DNS 解析

如果没命中缓存，浏览器会通过 DNS 解析，将域名转换为服务器 IP 地址。以 `www.example.com` 为例过程大致如下：

1. 浏览器缓存：检查是否缓存了这个域名的 IP 地址，如果有且没过期，直接使用，解析结束；
2. 操作系统缓存：如果浏览器没有缓存，会向操作系统查询，操作系统会维护一个 DNS 缓存（也可能查 /etc/hosts 文件），如果查到就返回结果；
3. 本地 DNS 服务器：如果操作系统没有缓存，会向配置好的本地 DNS 服务器（通常是网络运营商的 DNS）发起查询。
4. 递归查询：如果本地 DNS 服务器没有结果，会递归查询其它 DNS 服务器来获得答案；
   - 根域名服务器（Root DNS）：告诉本地 DNS .com 顶级域的服务器地址。
   - 顶级域名服务器（TLD DNS）：比如 .com 的服务器，告诉它 example.com 的权威 DNS。
   - 权威 DNS 服务器：最终给出 www.example.com 对应的 IP 地址。
5. 返回并缓存结果：本地 DNS 拿到结果返回给客户端，并缓存一定时间以加速后续解析。

## 建立 TCP 连接

浏览器与目标服务器建立 TCP 连接，确保双方可以可靠通信。

TCP 连接通过**三次握手**进行建立，确保双方都准备好发送和接收数据。三次握手过程如下：

**1. 第一次握手（Client -> Server）**
   客户端发送一个 **SYN** 报文（同步序列号）给服务器，表示请求建立连接；
   - 报文标志: `SYN = 1`
   - 序列号: `Seq = x`（x 为客户端初始序列号）
**2. 第二次握手（Server -> Client）**
   服务器收到 SYN 报文后，确认接收到，并发送一个 **SYN + ACK** 报文回客户端
   - 报文标志：`SYN = 1, ACK = 1`
   - 序列号：`Seq = y` （y 为服务器初始序列号）
   - 确认号：`Ack = x + 1` （确认客户端的序列号）
**3. 第三次握手（Client Server）**
   客户端收到 SYN + ACK 报文后，在发送一个 **ACK** 报文给服务器，表示握手完成
   - 报文标志：`ACK = 1`
   - 序列号：`Seq = x + 1`
   - 确认号: `Ack = y + 1`
 
   回传 ACK 表明从客户端到服务端的通信正常，回传 SYN 是为了建立并确认从服务端到客户端的通信。

三次握手核心目的是：**确认彼此的接收与发送能力**；

:::tip 
SYN 同步序列编号是 TCP/IP 建立连接时使用的握手信号。
:::

如果是 HTTPS，还会进行 TSL/SSL 握手，协商加密算法，验证证书，建立安全通道。

## 发送 HTTP/HTTPS 请求

浏览器构造 HTTP 请求报文，发送到服务器。请求内容包含请求行、请求头、请求体等。

## 服务器处理请求并返回相应

服务器收到请求后，处理相关业务逻辑，并返回 HTTP 响应报文。

## 浏览器接收响应

浏览器收到响应后，先根据响应头判断资源类型、缓存策略、重定向等。


## 渲染页面

1. 解析 HTML，构建 DOM
2. 解析 CSS，构建 CSSOM 树
3. 合成渲染书
4. 布局
5. 绘制
6. 合成

## 执行 JS、渲染交互

浏览器执行页面中的 JavaScript，处理交互、数据请求、动态渲染等。

## 关闭连接

HTTP/1.0 默认**短连接**，每次请求后自动关闭连接。如果客户端希望保持连接，需要显示添加

```http
Connection: keep-alive
```
服务器必须支持该头，否则请求处理后仍会自动关闭连接。

HTTP/1.1 默认**长连接**（keep-alive），如果客户端或服务器希望关闭连接，需要显示指定
```http
Connection: close
```

一旦一方发出 `connection:close` 响应或请求处理完成后，连接就会关闭。

HTTP/2 默认持久连接，不再使用 `Connection` 头来控制关闭，使用高级的多路复用、流（Stream）机制，

关闭方式：使用 GOAWAY 帧 来优雅地通知对方关闭连接。也可以在完成所有流之后，直接关闭 TCP 连接。

--- 

HTTP 连接关闭只是指应用层告知传输层不在需要使用该连接进行通信，不意味着连接会立刻关闭。TCP 四次挥手才是终止物理连接的过程。

四次挥手过程：

**1. 第一次挥手（Client -> Server）**

   客户端主动关闭连接时，发送一个 FIN 报文（表示客户端没有数据要发送了），请求终止连接。
   
   - 报文标志: FIN = 1
   - 序列号: Seq = u（u 为客户端的当前序列号）

   说明：客户端告诉服务器自己发送完数据，要关闭连接。

**2. 第二次挥手（Server -> Client）**

   服务器收到 FIN 报文后，发送一个 ACK 报文给客户端，表示确认客户端的关闭请求。
   
   - 报文标志: ACK = 1
   - 序列号: Seq = v（v 为服务器的当前序列号）
   - 确认号: Ack = u + 1（确认收到客户端的 FIN 报文）

   说明：服务器告知客户端自己已经准备好关闭连接，但如果服务器还有数据要发送，它不会立刻关闭连接。

**3. 第三次挥手（Server -> Client）**

   服务器发送完数据后，发送 FIN 报文给客户端，表示自己也不再有数据要发送，准备关闭连接。

   - 报文标志: FIN = 1, ACK = 1
   - 序列号: Seq = v + 1（服务器的下一个序列号）
   - 确认号: Ack = u + 1（确认客户端的关闭请求）

   说明：服务器发送的 FIN 报文表示连接的关闭。

**4. 第四次挥手（Client -> Server）**

   客户端收到服务器的 FIN 报文后，发送一个 ACK 报文，确认收到服务器的关闭请求，客户端进入关闭连接状态。
   
   - 报文标志: ACK = 1
   - 序列号: Seq = u + 1（客户端的下一个序列号）
   - 确认号: Ack = v + 1（确认服务器的 FIN 报文）
   
   说明：客户端告知服务器，它已经准备好关闭连接，并且 TCP 连接完全断开。
